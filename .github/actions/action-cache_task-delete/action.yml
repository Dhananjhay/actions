---
name: Delete cache from repository
description: Due to cache scopes, caches need to be deleted after upon merging
inputs:
  token:
    description: Regular github token to be passed
    required: true
    type: string

runs:
  using: composite
  steps:
    - name: Clear cache
      if: github.event.pull_request.merged == true
      env:
        GH_TOKEN: ${{ inputs.token }}
      shell: bash
      run: |
        gh extension install actions/gh-actions-cache

        # Get relevant branch info
        REPO=${{ github.repository }}
        BRANCH=refs/pull/${{ github.event.pull_request.number }}/merge

        # Grab all caches created by PR
        echo "Fetching list of cache keys..."
        cacheKeysForPR=$(gh actions-cache list -R $REPO -B $BRANCH | cut -f 1 )

        # Set to not fail while deleting cache keyes
        set +e 
        echo "Deleting caches..."
        for cacheKey in $cacheKeysForPR
        do
          gh actions-cache delete $cacheKey -R $REPO -B $BRANCH --confirm
        done
        echo "Finished deleting caches created for $BRANCH"
